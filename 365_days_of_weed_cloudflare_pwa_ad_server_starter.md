# 365DaysOfWeed — Cloudflare PWA + Ad Server Starter

A ready‑to‑deploy Cloudflare Workers + React PWA starter that serves **location‑aware and day‑aware ads**, daily content cards, private journals, and push notifications. Built to run on: **Workers (TS)** + **Hono** + **D1** + **KV** + **R2** + **Queues** + **Durable Objects**.

---

## Repo layout

```
365daysofweed/
├─ README.md
├─ wrangler.toml
├─ package.json
├─ .gitignore
├─ /worker
│  ├─ index.ts                  # Hono app, routes mount
│  ├─ routes/
│  │  ├─ today.ts               # GET /api/today
│  │  ├─ ads.ts                 # GET /api/ads, POST /api/track
│  │  ├─ journal.ts             # POST /api/journal, GET /api/journal
│  │  ├─ push.ts                # POST /api/push/subscribe
│  │  └─ render.ts              # SSR snapshot for SEO/AIEO
│  ├─ lib/
│  │  ├─ db.ts                  # D1 helpers
│  │  ├─ kv.ts                  # KV helpers (ads & cache)
│  │  ├─ geo.ts                 # IP→region fallback, input validation
│  │  └─ webpush.ts             # VAPID + send web push
│  ├─ queue-consumer.ts         # Daily fan-out for push notifications
│  ├─ durable.ts                # Durable Object for rate limiting/session
│  ├─ schema.sql                # D1 schema
│  ├─ seed/
│  │  ├─ day_cards.csv          # 30 demo day-cards
│  │  └─ seed.ts                # D1 seeder (wrangler d1 execute)
│  └─ types.ts
├─ /ads                         # Optional KV seed snapshots for local testing
│  ├─ CA-2025-10-18.json
│  ├─ CA-sleep.json             # tag-based creative
│  └─ CO-2025-10-18.json
└─ /app                         # React PWA (Vite)
   ├─ index.html
   ├─ manifest.webmanifest
   ├─ vite.config.ts
   ├─ package.json
   └─ src/
      ├─ main.tsx
      ├─ App.tsx
      ├─ routes/
      │  ├─ Today.tsx
      │  ├─ Calendar.tsx
      │  └─ Journal.tsx
      ├─ lib/api.ts
      ├─ lib/push.ts
      └─ sw.ts                  # service worker (workbox-lite style)
```

---

## Quickstart (deploy in ~10 minutes)

```bash
# 1) Install deps
npm i

# 2) Cloudflare resources
wrangler d1 create 365db
wrangler kv:namespace create 365_CACHE
wrangler kv:namespace create ADS
wrangler r2 bucket create weed-assets
wrangler queues create daily-broadcast

# 3) Bind secrets
wrangler secret put VAPID_PRIVATE_KEY
wrangler secret put VAPID_PUBLIC_KEY

# 4) Apply DB schema
wrangler d1 execute 365db --file ./worker/schema.sql

# 5) Seed sample content
wrangler d1 execute 365db --file ./worker/seed/seed.sql  # generated by seed.ts

# 6) Dev
wrangler dev --local

# 7) Deploy API
wrangler deploy

# 8) Build PWA & host via Pages *or* static assets route
cd app && npm i && npm run build
# Option A: Cloudflare Pages → set build output to app/dist
# Option B: Serve /app/dist via Worker (small assets) using R2/Cache
```

> Tip: For first launch, you can skip Queues and Push; everything else will run.

---

## `wrangler.toml`

```toml
name = "weed365"
main = "worker/index.ts"
compatibility_date = "2025-10-01"
workers_dev = true

[[d1_databases]]
binding = "DB"
database_name = "365db"
database_id = "REPLACE_WITH_ID"

[[kv_namespaces]]
binding = "CACHE"
id = "REPLACE_WITH_ID"

[[kv_namespaces]]
binding = "ADS"
id = "REPLACE_WITH_ID"

[[r2_buckets]]
binding = "ASSETS"
bucket_name = "weed-assets"

[[queues.producers]]
binding = "DAILY_QUEUE"
queue = "daily-broadcast"

[[queues.consumers]]
queue = "daily-broadcast"
max_batch_size = 50
max_retries = 3
dead_letter_queue = false

[vars]
APP_BASE_URL = "https://365daysofweed.com"
PUSH_SENDER = "mailto:admin@365daysofweed.com"
```

---

## D1 schema (`worker/schema.sql`)

```sql
PRAGMA foreign_keys=ON;

CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT UNIQUE,
  created_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS profiles (
  user_id INTEGER PRIMARY KEY,
  display_name TEXT,
  tz TEXT,
  state_code TEXT,
  is_21 INTEGER DEFAULT 0,
  FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS day_cards (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT UNIQUE,                  -- YYYY-MM-DD
  slug TEXT,
  title TEXT,
  body_md TEXT,
  spotlight_json TEXT,               -- effect/terp JSON
  tags TEXT,                         -- comma sep
  hero_url TEXT,
  published_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS journal (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER,
  date TEXT,
  method TEXT,                       -- vape/edible/joint/topical
  amount REAL,
  units TEXT,                        -- mg, puffs, g
  mood_before INTEGER,
  mood_after INTEGER,
  sleep_hours REAL,
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS reminders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER,
  kind TEXT,                         -- hydration, tbreak, bedtime
  cron_expr TEXT,
  enabled INTEGER DEFAULT 1,
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS push_subscriptions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER,
  endpoint TEXT,
  p256dh TEXT,
  auth TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- Ads & tracking
CREATE TABLE IF NOT EXISTS ads (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  region TEXT,                       -- e.g., CA, CO, or CA:LA
  tag TEXT,                          -- e.g., sleep, focus; NULL if generic
  start_date TEXT,
  end_date TEXT,
  title TEXT,
  body_md TEXT,
  image_url TEXT,
  target_url TEXT,
  sponsor_name TEXT,
  cpm_rate REAL,
  created_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_ads_region_dates ON ads(region, start_date, end_date);
CREATE INDEX IF NOT EXISTS idx_ads_tag ON ads(tag);

CREATE TABLE IF NOT EXISTS ad_impressions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  ad_id INTEGER,
  user_id INTEGER,
  date TEXT,                         -- YYYY-MM-DD
  event_type TEXT,                   -- view|click
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY(ad_id) REFERENCES ads(id)
);
```

---

## Worker app (Hono) — `worker/index.ts`

```ts
import { Hono } from 'hono'
import { cors } from 'hono/cors'
import today from './routes/today'
import ads from './routes/ads'
import journal from './routes/journal'
import push from './routes/push'
import { renderTodayHTML } from './routes/render'

export interface Env {
  DB: D1Database
  CACHE: KVNamespace
  ADS: KVNamespace
  ASSETS: R2Bucket
  DAILY_QUEUE: Queue<any>
  APP_BASE_URL: string
  PUSH_SENDER: string
  VAPID_PRIVATE_KEY: string
  VAPID_PUBLIC_KEY: string
}

const app = new Hono<{ Bindings: Env }>()
app.use('*', cors())

app.route('/api/today', today)
app.route('/api/ads', ads)
app.route('/api/journal', journal)
app.route('/api/push', push)

// SEO snapshot endpoints
app.get('/today', async (c) => c.html(await renderTodayHTML(c)))
app.get('/:y/:m/:d', async (c) => c.html(await renderTodayHTML(c)))

export default app
```

---

## Ads routes — `worker/routes/ads.ts`

```ts
import { Hono } from 'hono'
import { z } from 'zod'

const qSchema = z.object({
  state: z.string().length(2).optional(),
  tag: z.string().optional(),
  date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional()
})

const r = new Hono<{ Bindings: Env }>()

r.get('/', async (c) => {
  const { state, tag, date } = qSchema.parse(Object.fromEntries(new URL(c.req.url).searchParams))
  const today = date ?? new Date().toISOString().slice(0,10)
  const region = (state ?? 'NA').toUpperCase()

  // 1) Try KV by exact key: ADS: `${region}-${today}`
  const kvKey = `${region}-${today}`
  const kv = await c.env.ADS.get(kvKey, 'json') as any
  if (kv) return c.json({ source: 'kv', items: Array.isArray(kv) ? kv : [kv] })

  // 2) Fallback: tag-based KV (e.g., CA-sleep)
  if (tag) {
    const tagKey = `${region}-${tag}`
    const kvTag = await c.env.ADS.get(tagKey, 'json') as any
    if (kvTag) return c.json({ source: 'kv:tag', items: Array.isArray(kvTag) ? kvTag : [kvTag] })
  }

  // 3) Fallback: D1 query window
  const { results } = await c.env.DB.prepare(
    `SELECT * FROM ads
     WHERE region = ? AND date(?) BETWEEN start_date AND end_date
       AND (tag IS NULL OR tag = COALESCE(?, tag))
     ORDER BY RANDOM() LIMIT 3`
  ).bind(region, today, tag ?? null).all()

  return c.json({ source: 'd1', items: results })
})

// Click/view tracker via POST to avoid ad blockers
r.post('/track', async (c) => {
  const body = await c.req.json<{ ad_id: number; user_id?: number; event: 'view'|'click'; date?: string }>()
  const date = body.date ?? new Date().toISOString().slice(0,10)
  await c.env.DB.prepare(
    'INSERT INTO ad_impressions(ad_id, user_id, date, event_type) VALUES (?, ?, ?, ?)'
  ).bind(body.ad_id, body.user_id ?? null, date, body.event).run()
  return c.json({ ok: true })
})

export default r
```

---

## Today route — `worker/routes/today.ts`

```ts
import { Hono } from 'hono'

const r = new Hono<{ Bindings: Env }>()

r.get('/', async (c) => {
  const date = new URL(c.req.url).searchParams.get('date') ?? new Date().toISOString().slice(0,10)
  const cacheKey = `today:${date}`
  const cached = await c.env.CACHE.get(cacheKey)
  if (cached) return c.json(JSON.parse(cached))

  const row = await c.env.DB.prepare('SELECT * FROM day_cards WHERE date = ?').bind(date).first()
  if (!row) return c.json({ date, title: 'Coming soon', body_md: 'Stay tuned!' })

  await c.env.CACHE.put(cacheKey, JSON.stringify(row), { expirationTtl: 3600 })
  return c.json(row)
})

export default r
```

---

## Journal route — `worker/routes/journal.ts`

```ts
import { Hono } from 'hono'

const r = new Hono<{ Bindings: Env }>()

r.post('/', async (c) => {
  const b = await c.req.json()
  const stmt = c.env.DB.prepare(
    `INSERT INTO journal (user_id, date, method, amount, units, mood_before, mood_after, sleep_hours, notes)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`
  )
  await stmt.bind(
    b.user_id ?? null,
    b.date ?? new Date().toISOString().slice(0,10),
    b.method ?? null,
    b.amount ?? null,
    b.units ?? null,
    b.mood_before ?? null,
    b.mood_after ?? null,
    b.sleep_hours ?? null,
    b.notes ?? null
  ).run()
  return c.json({ ok: true })
})

r.get('/', async (c) => {
  const user_id = Number(new URL(c.req.url).searchParams.get('user_id'))
  const { results } = await c.env.DB.prepare('SELECT * FROM journal WHERE user_id = ? ORDER BY date DESC LIMIT 90').bind(user_id).all()
  return c.json(results)
})

export default r
```

---

## Push route — `worker/routes/push.ts`

```ts
import { Hono } from 'hono'
import { sendWebPush } from '../lib/webpush'

const r = new Hono<{ Bindings: Env }>()

r.post('/subscribe', async (c) => {
  const b = await c.req.json()
  await c.env.DB.prepare(
    'INSERT INTO push_subscriptions (user_id, endpoint, p256dh, auth) VALUES (?, ?, ?, ?)'
  ).bind(b.user_id ?? null, b.endpoint, b.keys.p256dh, b.keys.auth).run()
  return c.json({ ok: true })
})

r.post('/test', async (c) => {
  const { results } = await c.env.DB.prepare('SELECT * FROM push_subscriptions ORDER BY id DESC LIMIT 1').all()
  if (!results?.length) return c.json({ ok: false, error: 'no subs' }, 404)
  const sub = results[0]
  await sendWebPush(c.env, sub, { title: '365', body: 'Hello from Workers Push!' })
  return c.json({ ok: true })
})

export default r
```

---

## Web Push helper — `worker/lib/webpush.ts`

```ts
import { WebPush } from 'minipush' // tiny web push lib for Workers

export async function sendWebPush(env: Env, sub: any, payload: any) {
  const wp = new WebPush({
    subject: env.PUSH_SENDER,
    publicKey: env.VAPID_PUBLIC_KEY,
    privateKey: env.VAPID_PRIVATE_KEY
  })
  await wp.send({
    endpoint: sub.endpoint,
    keys: { p256dh: sub.p256dh, auth: sub.auth }
  }, JSON.stringify(payload))
}
```

---

## Example ads JSON (KV seeds in `/ads`)

**`ads/CA-2025-10-18.json`**
```json
{
  "id": 9001,
  "region": "CA",
  "title": "LA’s Sleep Gummies – 20% Off Tonight",
  "body_md": "New CBN blend. Pickup in Westside. 21+ only.",
  "image_url": "https://cdn.example.com/ads/la-cbn.png",
  "target_url": "https://partner.example.com/cbn?cmp=la_sleep",
  "sponsor_name": "DreamCo",
  "cpm_rate": 8.5,
  "start_date": "2025-10-15",
  "end_date": "2025-10-22"
}
```

**`ads/CA-sleep.json`** (tag-based fallback)
```json
[
  {
    "id": 9101,
    "region": "CA",
    "tag": "sleep",
    "title": "Wind Down Kit: CBN + Chamomile",
    "body_md": "Bundle deal ends Sunday.",
    "image_url": "https://cdn.example.com/ads/winddown.png",
    "target_url": "https://partner.example.com/winddown?cmp=sleep_bundle",
    "sponsor_name": "Rest Labs",
    "cpm_rate": 7.0,
    "start_date": "2025-10-01",
    "end_date": "2025-12-31"
  }
]
```

> Load these into KV with keys: `CA-2025-10-18` and `CA-sleep`.

---

## React PWA essentials (selected files)

**`app/manifest.webmanifest`**
```json
{
  "name": "365 Days of Weed",
  "short_name": "Weed365",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#0b0f0e",
  "theme_color": "#17a34a",
  "icons": [
    {"src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png"},
    {"src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png"}
  ]
}
```

**`app/src/lib/api.ts`**
```ts
export async function getToday(date?: string) {
  const q = date ? `?date=${date}` : ''
  const r = await fetch(`/api/today${q}`)
  return r.json()
}

export async function getAds(state?: string, tag?: string, date?: string) {
  const p = new URLSearchParams()
  if (state) p.set('state', state)
  if (tag) p.set('tag', tag)
  if (date) p.set('date', date)
  const r = await fetch(`/api/ads?${p}`)
  return r.json()
}

export async function trackAd(ad_id: number, event: 'view'|'click') {
  return fetch('/api/ads/track', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ ad_id, event }) })
}
```

**`app/src/sw.ts`** (minimal app-shell + background sync)
```ts
self.addEventListener('install', (e: any) => {
  e.waitUntil(caches.open('app-shell-v1').then(c => c.addAll([
    '/', '/index.html', '/manifest.webmanifest'
  ])))
})

self.addEventListener('fetch', (event: any) => {
  const url = new URL(event.request.url)
  if (url.pathname.startsWith('/api/')) {
    event.respondWith((async () => {
      try {
        const res = await fetch(event.request)
        const clone = res.clone()
        const cache = await caches.open('api-cache')
        cache.put(event.request, clone)
        return res
      } catch {
        const cache = await caches.open('api-cache')
        const cached = await cache.match(event.request)
        return cached ?? new Response(JSON.stringify({ offline: true }), { headers: { 'content-type': 'application/json' } })
      }
    })())
    return
  }
})
```

**`app/src/routes/Today.tsx`** (ad render snippet)
```tsx
import { useEffect, useState } from 'react'
import { getToday, getAds, trackAd } from '../lib/api'

export default function Today() {
  const [card, setCard] = useState<any>()
  const [ads, setAds] = useState<any[]>([])

  useEffect(() => {
    getToday().then(setCard)
    // Ask for location politely, fallback to profile state
    const state = localStorage.getItem('state_code') ?? undefined
    getAds(state).then((r) => setAds(r.items ?? []))
  }, [])

  useEffect(() => {
    ads.forEach((a) => trackAd(a.id, 'view'))
  }, [ads])

  return (
    <div className="p-4 space-y-4">
      <section className="rounded-2xl p-4 bg-green-100 dark:bg-green-900/30">
        <h1 className="text-xl font-semibold">{card?.title ?? 'Today'}</h1>
        <article className="prose prose-sm" dangerouslySetInnerHTML={{__html: (card?.body_md || '').replace(/\n/g,'<br/>')}} />
      </section>

      {ads.length > 0 && (
        <section className="space-y-3">
          <div className="text-xs uppercase tracking-wide opacity-60">Sponsored</div>
          {ads.map((ad) => (
            <a key={ad.id} href={ad.target_url} onClick={() => trackAd(ad.id, 'click')} className="block rounded-xl overflow-hidden border hover:shadow">
              <div className="flex gap-3">
                {ad.image_url && <img src={ad.image_url} alt="ad" className="w-28 h-28 object-cover"/>}
                <div className="p-3">
                  <div className="font-semibold">{ad.title}</div>
                  <div className="text-sm opacity-80" dangerouslySetInnerHTML={{__html: ad.body_md}} />
                  <div className="text-xs mt-2 opacity-60">{ad.sponsor_name}</div>
                </div>
              </div>
            </a>
          ))}
        </section>
      )}
    </div>
  )
}
```

---

## Seed day cards — `worker/seed/seed.sql` (excerpt)

```sql
INSERT INTO day_cards(date, slug, title, body_md, spotlight_json, tags, hero_url) VALUES
('2025-10-18','sleep-cbn','Wind-Down Routine','**Safer-use tip:** keep a hydration bottle by the bed.\n**Terp spotlight:** linalool.','{"effects":["sleep","calm"],"terpenes":["linalool"]}','sleep','https://cdn.example.com/hero/sleep.jpg');
```

---

## Privacy/Compliance copy (drop in your footer)

```
For adults 21+ in legal jurisdictions. Educational content only; not medical advice. Location is optional and used to personalize offers. You can disable personalized ads anytime.
```

---

## Roadmap (fast iterations)

- [x] Stripe + “Remove Ads” ($1.99/mo) & advanced trends (spec below)
- [x] Partner self‑serve portal (upload creatives, set dates/regions)
- [ ] Client‑side interest inference → request tag ads (sleep/focus/pain)
- [ ] State/metro granularity (e.g., CA:LA vs CA:SF)
- [ ] Analytics export to R2 daily (CSV) for sponsors

---

# Partner Portal + Stripe Pro Add‑On

This extends the starter with a sponsor/partner portal (CRUD ads/campaigns, assets to R2) and a Stripe subscription that removes ads + unlocks insights.

## New D1 Tables (append to schema.sql)
```sql
CREATE TABLE IF NOT EXISTS partners (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT,
  email TEXT UNIQUE,
  created_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS partner_api_keys (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  partner_id INTEGER,
  api_key TEXT UNIQUE,
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY(partner_id) REFERENCES partners(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS campaigns (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  partner_id INTEGER,
  name TEXT,
  region TEXT,
  tag TEXT,
  start_date TEXT,
  end_date TEXT,
  status TEXT DEFAULT 'active',
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY(partner_id) REFERENCES partners(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS creatives (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  campaign_id INTEGER,
  title TEXT,
  body_md TEXT,
  image_url TEXT,
  target_url TEXT,
  cpm_rate REAL,
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY(campaign_id) REFERENCES campaigns(id) ON DELETE CASCADE
);

-- Stripe
CREATE TABLE IF NOT EXISTS subscriptions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER,
  stripe_customer_id TEXT,
  stripe_subscription_id TEXT,
  status TEXT,
  current_period_end INTEGER,
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

## Wrangler additions (env vars)
```toml
[vars]
STRIPE_PRICE_ID = "price_xxx_monthly"
STRIPE_WEBHOOK_SECRET = "whsec_..."
STRIPE_PUBLISHABLE_KEY = "pk_live_..."

[[r2_buckets]]
binding = "PARTNER_ASSETS"
bucket_name = "weed-partner-assets"
```
Add secrets: `wrangler secret put STRIPE_SECRET_KEY` (sk_live_...).

## Worker routes added

### `worker/routes/partners.ts`
- `POST /api/partners/signup` → magic‑link (email) + Turnstile check, create partner.
- `POST /api/partners/login` → verify code, set JWT cookie (HttpOnly) signed with Worker `JWT_SECRET`.
- `GET  /api/partners/me` → profile + campaigns.
- `POST /api/partners/campaigns` → create campaign (region/tag/dates), validates ranges.
- `POST /api/partners/creatives` → upload creative metadata; images go to **R2 PARTNER_ASSETS** (signed PUT URL flow).
- `GET  /api/partners/analytics?campaign_id=...` → returns daily views/clicks (from `ad_impressions`).

> For delivery, `GET /api/ads` now prefers active `creatives` joined via `campaigns` before KV/D1 legacy records.

**Snippets**
```ts
// Signed upload URL (R2)
r.post('/assets/sign', async (c) => {
  const { filename, type } = await c.req.json()
  const key = `creatives/${crypto.randomUUID()}-${filename}`
  const url = await getSignedPutUrl(c.env.PARTNER_ASSETS, key, type)
  return c.json({ key, url })
})

// Create campaign
r.post('/campaigns', async (c) => {
  const b = await c.req.json()
  // validate dates, region, etc.
  await c.env.DB.prepare(
    `INSERT INTO campaigns (partner_id,name,region,tag,start_date,end_date) VALUES (?,?,?,?,?,?)`
  ).bind(c.get('partner_id'), b.name, b.region, b.tag ?? null, b.start_date, b.end_date).run()
  return c.json({ ok: true })
})
```

### `worker/routes/stripe.ts`
- `POST /api/stripe/create-session` → Stripe Checkout (Price: `STRIPE_PRICE_ID`), returns URL.
- `POST /api/stripe/portal` → Stripe Billing Portal URL for user.
- `POST /api/stripe/webhook` → handle `checkout.session.completed`, `customer.subscription.updated/deleted`; set `profiles.pro_until` or upsert `subscriptions`.

**Snippet**
```ts
import Stripe from 'stripe'
const stripe = new Stripe(env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' })

// Ad removal check (middleware)
app.use('*', async (c, next) => {
  const uid = await getUserId(c)
  if (uid) {
    const row = await c.env.DB.prepare("SELECT current_period_end, status FROM subscriptions WHERE user_id=? ORDER BY id DESC LIMIT 1").bind(uid).first()
    c.set('isPro', row && row.status==='active' && row.current_period_end*1000 > Date.now())
  }
  await next()
})
```

### Ad serving change
In `ads.ts` route, if `c.get('isPro') === true`, return `{ items: [] }` so the UI hides ads for Pro users.

## React — new screens (admin + pro)

### `/app/src/routes/PartnerDashboard.tsx`
- Tabs: Campaigns, Creatives, Analytics.
- New form w/ region picker (US states), tag picker (sleep/focus/pain/creativity/appetite).
- Upload flow: request signed URL → PUT blob → store `image_url`.

### Pro toggle in user settings
- Button “Go Ad‑Free + Insights ($1.99/mo)” → calls `/api/stripe/create-session`.
- If Pro, show Trends+ (7/30/90‑day charts, export CSV).

## Analytics Export (sponsor shareouts)
- Nightly Worker (Queue consumer) aggregates `ad_impressions` by `campaign_id,date` and writes `CSV` to **R2** at `analytics/YYYY-MM-DD.csv`.
- Optional signed GET endpoint for partners to download their slice.

**Aggregate SQL**
```sql
SELECT c.partner_id, ai.ad_id, date, SUM(event_type='view') AS views, SUM(event_type='click') AS clicks
FROM ad_impressions ai
JOIN ads a ON a.id=ai.ad_id
LEFT JOIN creatives cr ON cr.id=a.id  -- if mapping 1:1
LEFT JOIN campaigns c ON c.id=cr.campaign_id
WHERE date BETWEEN ? AND ?
GROUP BY 1,2,3;
```

## Security & Compliance
- All partner routes require JWT + Turnstile.
- Rate limit (Durable Object) by IP and partner_id.
- Validate target URLs, reject inline JS; sanitize `body_md`.
- Clear delineation: **education only**, 21+, local‑law banner. No interstate shipping promos in restricted locales.

## Deployment To‑Dos
1. `wrangler r2 bucket create weed-partner-assets`
2. `wrangler secret put STRIPE_SECRET_KEY`
3. Add `JWT_SECRET`, `TURNSTILE_SECRET_KEY`, `TURNSTILE_SITE_KEY` secrets.
4. Run DB migrations to add the new tables.
5. Build new React routes and link “Advertise” & “Go Pro” in the app menu.

---

## UX Copy (use as-is)
- **Advertise:** “Run location‑aware offers to adults 21+ right where they’re browsing. Upload creative, choose dates, and go live in minutes.”
- **Pro:** “Support the project, go ad‑free, and unlock deeper insights into your wellness trends.”

---

## Nice‑to‑Have Next
- Creative A/B testing with automatic winner rotation
- First‑party attribution window (7‑day) with privacy‑safe matching

---

# 🎟️ Coupon Codes, Pixels, and ROAS (Fully Wired)

Adds first‑party coupons with redemption tracking and ROAS analytics, designed for privacy‑safe attribution.

## New D1 Tables (append to `schema.sql`)
```sql
-- Coupon definitions owned by a campaign
CREATE TABLE IF NOT EXISTS coupons (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  campaign_id INTEGER,
  code TEXT UNIQUE,            -- e.g., REST‑SLEEP‑20 or randomized
  discount_type TEXT,          -- 'percent' | 'amount'
  discount_value REAL,         -- 20 (percent) or 10.00 (amount)
  region TEXT,                 -- optional constraint (CA or CA:LA)
  starts_at TEXT,
  ends_at TEXT,
  max_redemptions INTEGER,     -- e.g., 1000
  per_user_limit INTEGER,      -- e.g., 1
  status TEXT DEFAULT 'active',
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY(campaign_id) REFERENCES campaigns(id) ON DELETE CASCADE
);

-- Issued/personalized coupon instances (optional per‑user tracking)
CREATE TABLE IF NOT EXISTS coupon_issues (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  coupon_id INTEGER,
  user_hash TEXT,              -- hashed user id/email (if present)
  code TEXT UNIQUE,            -- can mirror coupons.code or be unique variant
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY(coupon_id) REFERENCES coupons(id) ON DELETE CASCADE
);

-- Redemptions recorded by pixel or webhook
CREATE TABLE IF NOT EXISTS redemptions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  coupon_code TEXT,
  campaign_id INTEGER,
  partner_id INTEGER,
  order_id TEXT,
  revenue REAL,
  currency TEXT DEFAULT 'USD',
  user_hash TEXT,
  redeemed_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_redemptions_coupon ON redemptions(coupon_code);
CREATE INDEX IF NOT EXISTS idx_redemptions_campaign ON redemptions(campaign_id);

-- Pixel fire logs (anti‑fraud + debugging)
CREATE TABLE IF NOT EXISTS pixel_events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  partner_id INTEGER,
  campaign_id INTEGER,
  coupon_code TEXT,
  order_id TEXT,
  revenue REAL,
  ip_hash TEXT,
  ua_hash TEXT,
  ts INTEGER
);
```

## Partner Secrets for Signing
Add per‑partner HMAC secret to prevent fake pixel fires.
```sql
ALTER TABLE partners ADD COLUMN hmac_secret TEXT; -- one‑time migration
```
Generate on signup; show once in portal.

## New/Updated Worker Routes

### `POST /api/partners/coupons`
Create coupon(s) for a campaign. Supports bulk random codes.
```ts
// body: { campaign_id, prefix?, count?, discount_type, discount_value, region?, starts_at, ends_at, max_redemptions, per_user_limit }
```

### `GET /api/partners/coupons?campaign_id=...`
List coupons with redemption counts.

### `POST /api/pixel`
Receives signed pixel fires from partner storefronts.
```ts
/* expected JSON
{
  partner_id, campaign_id, coupon_code, order_id, revenue, currency, t,
  sig // HMAC-SHA256 over `${partner_id}|${campaign_id}|${coupon_code}|${order_id}|${revenue}|${currency}|${t}`
}
*/
```
Validates:
- timestamp freshness (±10 minutes),
- HMAC with partner.hmac_secret,
- de‑dupe on `(partner_id, order_id)`.
Writes to `pixel_events` and upserts `redemptions`.

### `POST /api/webhooks/redemption`
Alternate server‑to‑server webhook for platforms that can’t run JS.

### `GET /c/:code`
Coupon landing/relay: logs click (impression→click→code view), then 302 to partner URL with UTM/`coupon_code` appended.

## Frontend Changes
- **Advertiser Portal** → new **Coupons** tab: create, bulk generate, export CSV.
- **Sponsored Tile** CTA → link to `/c/<code>` if a coupon is attached.
- **User**: optional “My Coupons” screen listing saved codes.

## Pixel Snippet (Partner Storefront)
Embed on order confirmation page (no PII sent; optional hashed email for user_hash).
```html
<script>
  (async function(){
    const payload = {
      partner_id: PARTNER_ID,
      campaign_id: CAMPAIGN_ID,
      coupon_code: COUPON_CODE,   // from cart/order
      order_id: ORDER_ID,         // merchant order id
      revenue: ORDER_TOTAL,       // number
      currency: 'USD',
      t: Math.floor(Date.now()/1000)
    };
    const base = `${payload.partner_id}|${payload.campaign_id}|${payload.coupon_code}|${payload.order_id}|${payload.revenue}|${payload.currency}|${payload.t}`;
    payload.sig = await hmac(base, PARTNER_HMAC_SECRET);
    await fetch('https://365daysofweed.com/api/pixel', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });
    async function hmac(str, key){
      const enc = new TextEncoder();
      const cryptoKey = await crypto.subtle.importKey('raw', enc.encode(key), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);
      const sigBuf = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(str));
      return Array.from(new Uint8Array(sigBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
  })();
</script>
```

> If partners can’t expose secrets client‑side, they should call **server‑to‑server** to `/api/webhooks/redemption` and compute HMAC on their server.

## ROAS & Reporting

### Daily ROAS by Campaign (SQL)
```sql
SELECT c.id AS campaign_id,
       DATE(r.redeemed_at) AS day,
       COUNT(DISTINCT r.order_id) AS orders,
       SUM(r.revenue) AS revenue,
       (SELECT COUNT(*) FROM ad_impressions ai JOIN ads a ON a.id=ai.ad_id WHERE a.region=c.region AND ai.date=DATE(r.redeemed_at)) AS views,
       (SELECT COUNT(*) FROM ad_impressions ai JOIN ads a ON a.id=ai.ad_id WHERE a.region=c.region AND ai.event_type='click' AND ai.date=DATE(r.redeemed_at)) AS clicks
FROM redemptions r
JOIN campaigns c ON c.id=r.campaign_id
WHERE r.redeemed_at >= DATE('now','-30 day')
GROUP BY 1,2
ORDER BY 2 DESC;
```

### Export
Nightly aggregator writes `analytics/ROAS-YYYY-MM-DD.csv` to R2 with: campaign, day, views, clicks, orders, revenue, est. CPM spend (if using CPM), eCPA, ROAS.

## Anti‑Fraud
- HMAC‑signed payloads, short timestamp window
- Hash IP/UA into `pixel_events` for flagged duplicates (no raw IP storage)
- De‑dupe on `(partner_id, order_id)` and on `(coupon_code, order_id)`
- Optional: require that `coupon_code` exists & is active for `campaign_id`

## UTM Enforcer
When rendering ad links, append UTM if missing:
```
utm_source=weed365&utm_medium=tile&utm_campaign={campaign_id}&utm_content={creative_id}&coupon={code}
```

## Compliance Notes
- Some jurisdictions restrict cannabis discounting; partners are responsible for legal compliance. Surface a checkbox “I confirm this offer complies with applicable laws.”
- Keep user‑level tracking opt‑in; use hashed identifiers only.

## Portal UX Copy
- “Generate up to 1,000 unique codes. Limit per user and set end date. We’ll track redemptions and ROAS for you—privacy first.”

---

## Roadmap Updates
- [x] Coupon codes + redemption pixels for ROAS ✅
- [ ] Frequency caps per user (KV key: `cap:<uid>:<ad_id>:YYYYMMDD`)
- [ ] Creative A/B testing with automatic winner rotation
- [ ] First‑party attribution window (7‑day) with privacy‑safe matching



---

# 🧪 A/B Testing, Frequency Caps, QR Coupons, and Demo Data

## Frequency Caps (KV + middleware)
**Goal:** Limit ad overexposure (e.g., max 2 views/ad/day/user).

### KV Keys
- `cap:<uid|anon>:<ad_id>:<yyyymmdd>` → integer count, TTL 24h

### Middleware Snippet (Worker `ads.ts` before returning items)
```ts
async function applyFreqCaps(c: any, items: any[], uid?: string){
  const day = new Date().toISOString().slice(0,10).replace(/-/g,'')
  const out: any[] = []
  for (const ad of items){
    const key = `cap:${uid??'anon'}:${ad.id}:${day}`
    const count = Number(await c.env.CACHE.get(key)) || 0
    if (count < 2){
      out.push(ad)
      await c.env.CACHE.put(key, String(count+1), { expirationTtl: 24*3600 })
    }
  }
  return out
}
```
Call `items = await applyFreqCaps(c, items, userId)` before response.

---

## Creative A/B Testing (Variant Rotation)

### Schema add
```sql
ALTER TABLE creatives ADD COLUMN variant_group TEXT;  -- same group = test cohort
ALTER TABLE creatives ADD COLUMN weight REAL DEFAULT 1.0; -- soft weight
```

### Selection logic
When multiple creatives match a campaign/region/date with the same `variant_group`, perform **weighted random** choice per request and log `ad_id` in `ad_impressions` as usual.

```ts
function weightedPick(creatives){
  const sum = creatives.reduce((s,c)=>s+(c.weight||1),0)
  let r = Math.random()*sum
  for (const c of creatives){ r -= (c.weight||1); if (r<=0) return c }
  return creatives[0]
}
```

### Auto‑winner (nightly)
Queue consumer computes CTR per group and nudges weights:
- winner: `weight = min(3.0, weight+0.5)`
- loser: `weight = max(0.2, weight-0.3)`
Store back to D1.

---

## 7‑Day Attribution Window (privacy‑safe)

### KV touchpoint
When a user clicks an ad, set:
- `attrib:<uid|anon>:<campaign_id>` → `{ campaign_id, ts }` TTL: **7 days**

On `/api/pixel` or redemptions webhook, if `user_hash` provided, attempt best‑effort join; else leave unattributed.

---

## QR Code Coupon Generator (SVG)
Generate printable QR for `/c/<code>`.

### Route
`GET /qr/:code.svg` → returns SVG (no external libs; TinyQRCode or path math).

```ts
import { Hono } from 'hono'
import { qrsvg } from '../lib/qr'
const r = new Hono<{ Bindings: Env }>()
r.get('/:code.svg', async (c) => {
  const code = c.req.param('code')
  const url = `${c.env.APP_BASE_URL}/c/${encodeURIComponent(code)}`
  const svg = qrsvg(url)
  return c.body(svg, 200, { 'content-type': 'image/svg+xml', 'cache-control':'public, max-age=31536000, immutable' })
})
export default r
```

**Use in Portal:** “Download QR” next to each coupon → prints great on posters.

---

## One‑Click Demo Dataset

### Seed script additions (`worker/seed/seed.sql`)
- Partner: **DreamCo** with HMAC secret
- Campaigns: `CA:sleep` and `CO:focus`
- Creatives: two variants per campaign (A/B)
- Coupons: 50 codes per campaign
- Day cards: 30 entries

```sql
INSERT INTO partners(name,email,hmac_secret) VALUES('DreamCo','ops@dreamco.example','DEMO_HMAC_SECRET');
INSERT INTO campaigns(partner_id,name,region,tag,start_date,end_date) VALUES(1,'Sleep CA','CA','sleep','2025-10-01','2025-12-31');
INSERT INTO creatives(campaign_id,title,body_md,image_url,target_url,weight,variant_group) VALUES
(1,'CBN Wind‑Down','Save 20% this week','https://cdn.demo/creatives/winddown.png','https://partner.demo/cbn',1.0,'SLEEP‑Q4'),
(1,'Night Calm','Bundle offer ends Sunday','https://cdn.demo/creatives/nightcalm.png','https://partner.demo/cbn',1.0,'SLEEP‑Q4');
INSERT INTO coupons(campaign_id,code,discount_type,discount_value,starts_at,ends_at,max_redemptions,per_user_limit) VALUES
(1,'REST‑SLEEP‑20','percent',20,'2025-10-01','2025-12-31',1000,1);
```

### Demo loader
Add `worker/seed/demo.ts` to populate DB + KV + R2 sample images.

---

## UI Wiring
- **Partner Portal → A/B:** show variant group & weight; chart CTR per variant.
- **Coupons tab:** “Download QR” → `/qr/<code>.svg`.
- **Settings:** toggle attribution consent; explain 7‑day window.
- **Ad server:** respects frequency caps; if all capped, return empty and show fallback educational tile.

---

## QA Checklist
- [ ] Ad views capped at 2 per user/ad/day (reset next day)
- [ ] A/B weights shift after nightly job based on CTR
- [ ] QR endpoint serves cacheable SVG 
- [ ] Demo data appears in portal; coupons redeemable
- [ ] Attribution key TTL exactly 7 days; deletes after

---

# ✅ Automated Test Plan + CI/CD (Wrangler + GitHub Actions)

## Test Harness Overview
- **Unit**: Vitest for Worker route logic (Hono handlers), DB stubs.
- **Integration**: Miniflare for Workers runtime (KV/R2/D1 in‑memory), hitting `/api/*` endpoints.
- **E2E**: Playwright for PWA (install banner, Today card, Sponsored tiles, Pro toggle, Portal flows).

## Dev Dependencies (add to `package.json`)
```json
{
  "devDependencies": {
    "vitest": "^2.1.1",
    "@cloudflare/vitest-pool-workers": "^0.4.0",
    "miniflare": "^3.20240904.0",
    "@playwright/test": "^1.47.0"
  },
  "scripts": {
    "test": "vitest --pool=threads --poolOptions.workers=1",
    "test:e2e": "playwright test",
    "cf:dev": "wrangler dev --local",
    "cf:deploy": "wrangler deploy",
    "migrations:create": "wrangler d1 migrations create 365db",
    "migrations:apply": "wrangler d1 migrations apply 365db"
  }
}
```

## Vitest + Miniflare Config (`vitest.config.ts`)
```ts
import { defineWorkersConfig } from '@cloudflare/vitest-pool-workers/config'
export default defineWorkersConfig({
  test: {
    poolOptions: {
      workers: {
        wrangler: { configPath: './wrangler.toml' }
      }
    }
  }
})
```

## Example Unit Test (`worker/tests/ads.spec.ts`)
```ts
import app from '../index'
import { env } from './env'
import { unstable_dev } from 'wrangler'
import { describe, it, expect, beforeAll, afterAll } from 'vitest'

let worker: any
beforeAll(async () => {
  worker = await unstable_dev('worker/index.ts', { experimental: { disableExperimentalWarning: true } })
})
afterAll(async () => { await worker.stop() })

describe('ads route', () => {
  it('serves KV day ad then falls back to D1', async () => {
    // Seed KV
    await env.ADS.put('CA-2099-01-01', JSON.stringify([{ id: 1, region: 'CA', title: 'Test' }]))
    const r1 = await worker.fetch('/api/ads?state=CA&date=2099-01-01')
    const j1 = await r1.json()
    expect(j1.source).toBe('kv')

    const r2 = await worker.fetch('/api/ads?state=CA&date=1999-01-01')
    const j2 = await r2.json()
    expect(['d1','kv','kv:tag']).toContain(j2.source)
  })
})
```

## Playwright Setup (`playwright.config.ts`)
```ts
import { defineConfig } from '@playwright/test'
export default defineConfig({
  webServer: {
    command: 'wrangler dev --local',
    port: 8787,
    reuseExistingServer: !process.env.CI
  },
  use: { baseURL: 'http://127.0.0.1:8787' }
})
```

## Example E2E (`e2e/today.spec.ts`)
```ts
import { test, expect } from '@playwright/test'

test('Today card renders and shows Sponsored', async ({ page }) => {
  await page.goto('/')
  await page.waitForSelector('text=Sponsored')
  const sponsored = await page.locator('text=Sponsored').count()
  expect(sponsored).toBeGreaterThan(0)
})
```

---

## D1 Migrations
Move from monolithic `schema.sql` to migrations.

```
wrangler d1 migrations create 365db init
# (Paste schema into created file under /migrations)
wrangler d1 migrations apply 365db
```

Add new tables/columns via subsequent `migrations create/apply`. Keep `seed.sql` only for demo data.

---

## GitHub Actions: CI + Deploy (`.github/workflows/deploy.yml`)
```yaml
name: CI & Deploy
on:
  push:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm ci
      - run: npm run test --if-present
      - run: npx playwright install --with-deps
      - run: npm run test:e2e --if-present

  deploy:
    needs: ci
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4
      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: |
            wrangler d1 migrations apply 365db --environment production
            wrangler deploy
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          TURNSTILE_SECRET_KEY: ${{ secrets.TURNSTILE_SECRET_KEY }}
```

### Secrets to add in GitHub repo
- `CF_API_TOKEN`, `CF_ACCOUNT_ID`
- `STRIPE_SECRET_KEY`, `JWT_SECRET`, `TURNSTILE_SECRET_KEY`

---

## Optional: Pages Build (PWA) Workflow (`deploy-pwa.yml`)
```yaml
name: Build PWA
on: { push: { branches: [ main ] } }
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: cd app && npm ci && npm run build
      - uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: weed365-pwa
          directory: app/dist
```

---

## Local DX Tips
- Use **Miniflare** to stub KV/R2/D1 for integration tests.
- Create `.dev.vars` with non‑secret defaults; use `wrangler secret` for prod only.
- Run `wrangler dev --test-scheduled` to exercise the nightly Queue job locally.

---

## Rollout Plan
1. Merge to `main` → CI runs unit+E2E.
2. If green, GitHub Action applies migrations and deploys Worker.
3. Pages workflow publishes the latest PWA assets.
4. Post‑deploy smoke test: `/api/health`, `/api/today`, `/api/ads`.

